apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    k8s-sidecar-target-directory: /tmp/dashboards/ot
  labels:
    grafana_dashboard: "1"
  name: statefulset-insights-grafana-dashboard
  namespace: monitoring

data:
  statefulset-insights.json: |-
    {"annotations":{"list":[{"builtIn":1,"datasource":{"type":"grafana","uid":"-- Grafana --"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","type":"dashboard"}]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"links":[],"panels":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[{"options":{"match":"null","result":{"text":"N/A"}},"type":"special"}],"max":100,"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"rgba(50, 172, 45, 0.97)","value":null},{"color":"rgba(237, 129, 40, 0.89)","value":80},{"color":"rgba(245, 54, 54, 0.9)","value":90}]},"unit":"percent"},"overrides":[]},"gridPos":{"h":5,"w":8,"x":0,"y":0},"id":2,"maxDataPoints":100,"options":{"minVizHeight":75,"minVizWidth":75,"orientation":"horizontal","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showThresholdLabels":false,"showThresholdMarkers":true,"sizing":"auto"},"pluginVersion":"11.1.0","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"disableTextWrap":false,"editorMode":"code","exemplar":false,"expr":"(sum(container_memory_working_set_bytes{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", container!=\"\", image!=\"\"}) / sum(kube_pod_container_resource_requests{job=\"kube-state-metrics\", resource=\"memory\", namespace=\"$namespace\", pod=~\"^$app_service.*$\"})) * 100","format":"time_series","fullMetaSearch":false,"includeNullMetadata":true,"instant":true,"interval":"10s","intervalFactor":1,"legendFormat":"__auto","range":false,"refId":"A","step":900,"useBackend":false}],"title":"Deployment memory usage","type":"gauge"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"decimals":2,"mappings":[{"options":{"match":"null","result":{"text":"N/A"}},"type":"special"}],"max":100,"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"rgba(50, 172, 45, 0.97)","value":null},{"color":"rgba(237, 129, 40, 0.89)","value":65},{"color":"rgba(245, 54, 54, 0.9)","value":90}]},"unit":"percent"},"overrides":[]},"gridPos":{"h":5,"w":8,"x":8,"y":0},"id":5,"maxDataPoints":100,"options":{"minVizHeight":75,"minVizWidth":75,"orientation":"horizontal","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showThresholdLabels":false,"showThresholdMarkers":true,"sizing":"auto"},"pluginVersion":"11.1.0","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"disableTextWrap":false,"editorMode":"code","expr":"sum(rate(container_cpu_usage_seconds_total{metrics_path=\"/metrics/cadvisor\", container!=\"\" ,cluster=\"$cluster\", image!=\"\",pod=~\"^$app_service.*$\",namespace=\"$namespace\",pod=~\"^$pods.*$\"}[5m])) / sum(kube_pod_container_resource_requests{cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"cpu\", job=\"kube-state-metrics\"})","format":"time_series","fullMetaSearch":false,"includeNullMetadata":true,"interval":"10s","intervalFactor":1,"legendFormat":"__auto","range":true,"refId":"A","step":900,"useBackend":false}],"title":"Deployment CPU usage","type":"gauge"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"none"},"overrides":[]},"gridPos":{"h":4,"w":8,"x":16,"y":0},"id":8,"maxDataPoints":100,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","exemplar":false,"expr":"sum(kube_statefulset_status_replicas_available{statefulset=\"$app_service\",namespace=\"$namespace\"})","instant":false,"interval":"","intervalFactor":2,"legendFormat":"__auto","range":true,"refId":"A","step":40}],"title":"Replicas Count","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"short"},"overrides":[]},"gridPos":{"h":4,"w":8,"x":16,"y":4},"id":9,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"9.3.6","targets":[{"datasource":{"uid":"$Datasource"},"editorMode":"code","expr":"kube_pod_container_status_restarts_total{namespace=\"$namespace\",pod=~\"^$app_service.*$\"}","instant":false,"interval":"","intervalFactor":1,"legendFormat":"{{pod}}","refId":"A"}],"title":"Pods Restarted","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"mappings":[{"options":{"match":"null","result":{"text":"N/A"}},"type":"special"}],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"bytes"},"overrides":[]},"gridPos":{"h":3,"w":4,"x":0,"y":5},"id":3,"maxDataPoints":100,"options":{"colorMode":"none","graphMode":"none","justifyMode":"auto","orientation":"horizontal","percentChangeColorMode":"standard","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showPercentChange":false,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.0","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"disableTextWrap":false,"editorMode":"code","exemplar":false,"expr":"sum(container_memory_working_set_bytes{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", container!=\"\", image!=\"\"})","format":"time_series","fullMetaSearch":false,"includeNullMetadata":true,"instant":true,"intervalFactor":2,"range":false,"refId":"A","step":1800,"useBackend":false}],"title":"Used Memory","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Rrequested memory by pod containers","fieldConfig":{"defaults":{"mappings":[{"options":{"match":"null","result":{"text":"N/A"}},"type":"special"}],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"bytes"},"overrides":[]},"gridPos":{"h":3,"w":4,"x":4,"y":5},"id":4,"maxDataPoints":100,"options":{"colorMode":"none","graphMode":"none","justifyMode":"auto","orientation":"horizontal","percentChangeColorMode":"standard","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showPercentChange":false,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.0","targets":[{"datasource":{"type":"prometheus","uid":"prometheus"},"disableTextWrap":false,"editorMode":"builder","expr":"sum(kube_pod_container_resource_requests{job=\"kube-state-metrics\", resource=\"memory\", namespace=\"$namespace\", pod=~\"^$app_service.*$\"})","format":"time_series","fullMetaSearch":false,"includeNullMetadata":true,"intervalFactor":2,"range":true,"refId":"A","step":1800,"useBackend":false}],"title":"Total Memory","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"decimals":3,"fieldMinMax":false,"mappings":[{"options":{"match":"null","result":{"text":"N/A"}},"type":"special"}],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"none"},"overrides":[]},"gridPos":{"h":3,"w":4,"x":8,"y":5},"id":7,"maxDataPoints":100,"options":{"colorMode":"none","graphMode":"none","justifyMode":"auto","orientation":"horizontal","percentChangeColorMode":"standard","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showPercentChange":false,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.0","targets":[{"datasource":{"type":"prometheus","uid":"prometheus"},"editorMode":"code","expr":"sum(rate(container_cpu_usage_seconds_total{metrics_path=\"/metrics/cadvisor\", container!=\"\" ,cluster=\"$cluster\", image!=\"\",pod=~\"^$app_service.*$\",namespace=\"$namespace\",pod=~\"^$pods.*$\"}[5m]))","format":"time_series","intervalFactor":2,"range":true,"refId":"A","step":1800}],"title":"Used","type":"stat"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"mappings":[{"options":{"match":"null","result":{"text":"N/A"}},"type":"special"}],"max":-3,"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"none"},"overrides":[]},"gridPos":{"h":3,"w":4,"x":12,"y":5},"id":6,"maxDataPoints":100,"options":{"colorMode":"none","graphMode":"none","justifyMode":"auto","orientation":"horizontal","percentChangeColorMode":"standard","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showPercentChange":false,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.0","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(kube_pod_container_resource_requests{cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"cpu\", job=\"kube-state-metrics\"})","intervalFactor":2,"range":true,"refId":"A","step":1800}],"title":"Total","type":"stat"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"cores","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":2,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":true,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"decimals":3,"fieldMinMax":true,"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"none"},"overrides":[{"matcher":{"id":"byFrameRefID","options":"B"},"properties":[{"id":"custom.lineStyle","value":{"dash":[10,10],"fill":"dash"}},{"id":"custom.lineWidth","value":2},{"id":"color","value":{"fixedColor":"red","mode":"fixed"}}]},{"matcher":{"id":"byFrameRefID","options":"C"},"properties":[{"id":"custom.lineStyle","value":{"dash":[10,10],"fill":"dash"}},{"id":"custom.lineWidth","value":2},{"id":"color","value":{"fixedColor":"orange","mode":"fixed"}}]}]},"gridPos":{"h":7,"w":12,"x":0,"y":8},"id":10,"options":{"legend":{"calcs":["mean","lastNotNull"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"desc"}},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(rate(container_cpu_usage_seconds_total{metrics_path=\"/metrics/cadvisor\", container!=\"\" ,cluster=\"$cluster\", image!=\"\",pod=~\"^$app_service.*$\",namespace=\"$namespace\",pod=~\"^$pods.*$\"}[5m])) by (pod)","interval":"10s","intervalFactor":1,"legendFormat":"{{ pod }}","metric":"container_cpu","range":true,"refId":"A","step":10},{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(kube_pod_container_resource_requests{job=\"kube-state-metrics\", container!=\"\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"cpu\"}) / count(kube_pod_container_resource_requests{job=\"kube-state-metrics\", container!=\"\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"cpu\"})","hide":false,"instant":false,"legendFormat":"requests","range":true,"refId":"B"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(kube_pod_container_resource_limits{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"cpu\"}) / count(kube_pod_container_resource_limits{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"cpu\"})","hide":false,"instant":false,"legendFormat":"limits","range":true,"refId":"C"}],"title":"CPU Core Usage - Pods","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":true,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"bytes"},"overrides":[{"matcher":{"id":"byFrameRefID","options":"B"},"properties":[{"id":"custom.lineStyle","value":{"fill":"dash"}},{"id":"custom.lineWidth","value":2},{"id":"color","value":{"fixedColor":"red","mode":"fixed"}}]},{"matcher":{"id":"byFrameRefID","options":"C"},"properties":[{"id":"custom.lineStyle","value":{"dash":[10,10],"fill":"dash"}},{"id":"custom.lineWidth","value":2},{"id":"color","value":{"fixedColor":"orange","mode":"fixed"}}]}]},"gridPos":{"h":7,"w":12,"x":12,"y":8},"id":11,"options":{"legend":{"asTable":true,"calcs":["lastNotNull"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"pluginVersion":"v11.0.0","targets":[{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(container_memory_working_set_bytes{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", container!=\"\", image!=\"\"}) by (pod)","hide":false,"legendFormat":"__auto","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(kube_pod_container_resource_requests{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"memory\"}) / count(kube_pod_container_resource_requests{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"memory\"})","hide":false,"legendFormat":"requests","range":true,"refId":"B"},{"datasource":{"type":"prometheus","uid":"${datasource}"},"editorMode":"code","expr":"sum(kube_pod_container_resource_limits{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"memory\"}) / count(kube_pod_container_resource_limits{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\", resource=\"memory\"})","hide":false,"legendFormat":"limits","range":true,"refId":"C"}],"title":"Memory Usage -- Pods (WSS)","type":"timeseries"}],"refresh":"1h","schemaVersion":39,"tags":["ot-dashboard"],"templating":{"list":[{"current":{"selected":false,"text":"kube-prom","value":"prometheus"},"hide":0,"includeAll":false,"label":"Data source","multi":false,"name":"datasource","options":[],"query":"prometheus","queryValue":"","refresh":1,"regex":"","skipUrlSync":false,"type":"datasource"},{"current":{"isNone":true,"selected":false,"text":"None","value":""},"datasource":{"type":"prometheus","uid":"${datasource}"},"definition":"label_values()","hide":2,"includeAll":false,"label":"cluster","multi":false,"name":"cluster","options":[],"query":{"qryType":1,"query":"label_values()","refId":"PrometheusVariableQueryEditor-VariableQuery"},"refresh":1,"regex":"","skipUrlSync":false,"sort":0,"type":"query"},{"current":{"selected":false,"text":"monitoring","value":"monitoring"},"datasource":{"type":"prometheus","uid":"${datasource}"},"definition":"label_values(kube_namespace_status_phase{job=\"kube-state-metrics\", cluster=\"$cluster\", phase=\"Active\"},namespace)","hide":0,"includeAll":false,"label":"Namespace","multi":false,"name":"namespace","options":[],"query":{"qryType":1,"query":"label_values(kube_namespace_status_phase{job=\"kube-state-metrics\", cluster=\"$cluster\", phase=\"Active\"},namespace)","refId":"PrometheusVariableQueryEditor-VariableQuery"},"refresh":2,"regex":"","skipUrlSync":false,"sort":1,"type":"query"},{"current":{"selected":true,"text":"monitoring-grafana","value":"monitoring-grafana"},"datasource":{"type":"prometheus","uid":"${datasource}"},"definition":"label_values(kube_statefulset_status_replicas_available{job=\"kube-state-metrics\", namespace=\"$namespace\", cluster=\"$cluster\"},statefulset)","hide":0,"includeAll":false,"label":"statefulset","multi":false,"name":"app_service","options":[],"query":{"qryType":1,"query":"label_values(kube_statefulset_status_replicas_available{job=\"kube-state-metrics\", namespace=\"$namespace\", cluster=\"$cluster\"},statefulset)","refId":"PrometheusVariableQueryEditor-VariableQuery"},"refresh":1,"regex":"","skipUrlSync":false,"sort":0,"type":"query"},{"allValue":".*","current":{"selected":true,"text":["All"],"value":["$__all"]},"datasource":{"type":"prometheus","uid":"${datasource}"},"definition":"label_values(kube_pod_info{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\"},pod)","hide":0,"includeAll":true,"label":"pods","multi":true,"name":"pods","options":[],"query":{"qryType":1,"query":"label_values(kube_pod_info{job=\"kube-state-metrics\", cluster=\"$cluster\", namespace=\"$namespace\", pod=~\"^$app_service.*$\"},pod)","refId":"PrometheusVariableQueryEditor-VariableQuery"},"refresh":1,"regex":"","skipUrlSync":false,"sort":1,"type":"query"}]},"time":{"from":"now-1h","to":"now"},"timepicker":{"refresh_intervals":["1m","5m","15m","30m","1h","2h","1d"]},"timezone":"browser","title":"Insights / Statefulset","uid":"ddukwuhu1eiv4eafas","version":1,"weekStart":""}